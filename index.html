<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Di√°rio Mobile Oficial</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>

    <style>
      :root {
        --primary: #2c3e50;
        --success: #27ae60;
        --danger: #e74c3c;
        --light: #f8f9fa;
      }
      body {
        font-family: sans-serif;
        background: #eaedf1;
        margin: 0;
        padding: 10px;
      }
      .container {
        max-width: 600px;
        margin: auto;
        background: white;
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      }
      .stats {
        display: flex;
        justify-content: space-around;
        background: var(--light);
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 15px;
        font-weight: bold;
        border: 1px solid #ddd;
      }
      .tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 15px;
        overflow-x: auto;
        padding-bottom: 5px;
      }
      .tab-btn {
        padding: 10px 15px;
        border: none;
        background: #dcdde1;
        border-radius: 8px;
        font-weight: bold;
        white-space: nowrap;
        cursor: pointer;
      }
      .tab-btn.active {
        background: var(--primary);
        color: white;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      td {
        padding: 12px 10px;
        border-bottom: 1px solid #eee;
        font-size: 16px;
      }
      .presence-check {
        width: 35px;
        height: 35px;
        cursor: pointer;
      }
      .actions {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        margin-top: 20px;
      }
      .btn {
        padding: 15px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        color: white;
        font-size: 14px;
        text-align: center;
      }
      .btn-sync {
        background: var(--primary);
        grid-column: span 2;
      }
      .btn-pdf {
        background: var(--danger);
        grid-column: span 2;
      }
      .btn-admin {
        background: #8e44ad;
        display: none;
        grid-column: span 2;
      }
      #statusLoader {
        text-align: center;
        color: #8e44ad;
        font-weight: bold;
        padding: 10px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h2 style="text-align: center; color: var(--primary)">
        Di√°rio de Classe
      </h2>
      <div id="statusLoader">Iniciando sistema...</div>

      <div class="stats">
        <span>Turma: <span id="nomeTurma">-</span></span>
        <span
          >Presentes: <span id="txtPres">0</span>/<span id="txtTotal"
            >0</span
          ></span
        >
      </div>

      <div class="tabs" id="tabContainer"></div>
      <table>
        <tbody id="corpoTabela"></tbody>
      </table>

      <div class="actions">
        <button class="btn btn-sync" onclick="sincronizarComGoogle()">
          ‚òÅÔ∏è Salvar Chamada na Nuvem
        </button>
        <button class="btn btn-pdf" onclick="exportarPDF()">
          üìÑ Gerar PDF da Chamada
        </button>
        <button
          id="btnImportar"
          class="btn btn-admin"
          onclick="document.getElementById('inputExcel').click()"
        >
          üì• Importar Excel (Admin)
        </button>
        <input
          type="file"
          id="inputExcel"
          accept=".xlsx, .xls"
          style="display: none"
        />
      </div>
    </div>

    <script>
      // ATEN√á√ÉO: Verifique se este link est√° correto!
      const SCRIPT_URL =
        "https://script.google.com/macros/s/AKfycbzKTF6hKO-E_P6K2bcJv1AvIXa3CLuomXZRClx3LTTqmwFtSAtbvwDfV52lJkJ9MaT0bg/exec";

      let dadosAlunos = JSON.parse(localStorage.getItem("diario_cloud")) || [];
      let turmaAtual = "";

      // 1. L√ìGICA DE VIS√ÉO ADMIN
      if (window.location.search.includes("admin=1")) {
        document.getElementById("btnImportar").style.display = "block";
      }

      // 2. CARREGAR DADOS (A M√ÅGICA PARA O PROFESSOR)
      async function inicializarApp() {
        const loader = document.getElementById("statusLoader");
        loader.innerText = "Buscando lista na nuvem...";

        try {
          // Tenta buscar do Google Sheets
          const response = await fetch(SCRIPT_URL);
          const dadosNuvem = await response.json();

          if (dadosNuvem && dadosNuvem.length > 0) {
            // Se achou no Google, atualiza a mem√≥ria local
            dadosAlunos = dadosNuvem.map((a) => ({
              nome: a.Nome,
              turma: a.Turma,
              presente: false,
            }));
            localStorage.setItem("diario_cloud", JSON.stringify(dadosAlunos));
            loader.innerText = "Lista atualizada via Nuvem!";
          }
        } catch (e) {
          loader.innerText =
            dadosAlunos.length > 0
              ? "Modo Offline (Dados Locais)"
              : "Erro: Sem internet e sem lista.";
        }

        if (dadosAlunos.length > 0) {
          turmaAtual = dadosAlunos[0].turma;
          renderizarTudo();
        }

        setTimeout(() => {
          loader.style.display = "none";
        }, 2000);
      }

      // 3. IMPORTAR EXCEL (S√ì ADMIN USA)
      document
        .getElementById("inputExcel")
        .addEventListener("change", function (e) {
          const reader = new FileReader();
          reader.onload = function (evt) {
            const wb = XLSX.read(evt.target.result, { type: "binary" });
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            dadosAlunos = json.map((item) => ({
              nome: (item["Nome "] || item.Nome || "Sem Nome")
                .toString()
                .trim(),
              turma: (item.Turma || "Geral").toString().trim(),
              presente: false,
            }));
            localStorage.setItem("diario_cloud", JSON.stringify(dadosAlunos));
            turmaAtual = dadosAlunos[0].turma;
            renderizarTudo();
            alert(
              "Excel Importado! Clique em 'Salvar na Nuvem' para enviar aos professores.",
            );
          };
          reader.readAsBinaryString(e.target.files[0]);
        });

      // 4. RENDERIZAR TELA
      function renderizarTudo() {
        const tabContainer = document.getElementById("tabContainer");
        const corpo = document.getElementById("corpoTabela");
        const turmas = [...new Set(dadosAlunos.map((a) => a.turma))];

        tabContainer.innerHTML = "";
        turmas.forEach((t) => {
          const btn = document.createElement("button");
          btn.className = `tab-btn ${t === turmaAtual ? "active" : ""}`;
          btn.innerText = t;
          btn.onclick = () => {
            turmaAtual = t;
            renderizarTudo();
          };
          tabContainer.appendChild(btn);
        });

        corpo.innerHTML = "";
        const filtrados = dadosAlunos.filter((a) => a.turma === turmaAtual);
        let pres = 0;

        filtrados.forEach((aluno) => {
          if (aluno.presente) pres++;
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${aluno.nome}</td><td align="right"><input type="checkbox" class="presence-check" ${aluno.presente ? "checked" : ""}></td>`;
          tr.querySelector("input").onchange = (e) => {
            const idx = dadosAlunos.findIndex((a) => a.nome === aluno.nome);
            dadosAlunos[idx].presente = e.target.checked;
            renderizarTudo();
          };
          corpo.appendChild(tr);
        });

        document.getElementById("nomeTurma").innerText = turmaAtual;
        document.getElementById("txtTotal").innerText = filtrados.length;
        document.getElementById("txtPres").innerText = pres;
      }

      // 5. SALVAR NO GOOGLE
      async function sincronizarComGoogle() {
        document.getElementById("statusLoader").style.display = "block";
        document.getElementById("statusLoader").innerText = "Enviando dados...";
        try {
          await fetch(SCRIPT_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify(dadosAlunos),
          });
          alert("Chamada enviada com sucesso!");
        } catch (e) {
          alert("Erro ao conectar com a planilha.");
        }
        document.getElementById("statusLoader").style.display = "none";
      }

      function exportarPDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const hoje = new Date().toLocaleDateString();
        doc.text(`Chamada: ${turmaAtual} - Data: ${hoje}`, 14, 15);
        const rows = dadosAlunos
          .filter((a) => a.turma === turmaAtual)
          .map((a) => [a.nome, a.presente ? "P" : "F"]);
        doc.autoTable({ head: [["Nome", "Presen√ßa"]], body: rows, startY: 20 });
        doc.save(`Chamada_${turmaAtual}.pdf`);
      }

      window.onload = inicializarApp;
    </script>
  </body>
</html>
